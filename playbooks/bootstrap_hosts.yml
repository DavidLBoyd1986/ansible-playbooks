---
- name: Bootstrap a host by configuring ansible User
  hosts: new
  become: true
  tasks:
  - name: Create the ansible user
    user:
      name: ansible
      shell: /bin/bash
      state: present

  - name: Add ansible to sudoers
    copy:
      dest: /etc/sudoers.d/sudo_users
      content: "ansible ALL=(ALL) NOPASSWD: ALL\n"
      mode: '0440'

  - name: Configure SSH key from ansible on controller, as authorized on hosts
    authorized_key:
      user: ansible
      key: "{{ lookup('file', '/home/{{ username }}/ansible/config_files/ansible_id_rsa.pub') }}"

  - name: Configure SSH key from User on controller, as authorized on hosts
    authorized_key:
      user: "{{ username }}"
      key: "{{ lookup('file', '/home/{{ username }}/ansible/config_files/{{ username }}_id_rsa.pub') }}"

- name: Configure a bastion host by configuring User with private ssh key
  hosts: rhel-bastion
  become: true
  tasks:
  - name: Copy private SSH key for User to be added on other Hosts
    copy:
      src: /home/{{ username }}/ansible/config_files/{{ username }}_id_rsa
      dest: /home/{{ username }}/.ssh/id_rsa
      mode: 0600
      owner: "{{ username }}"
      group: "{{ username }}"

- name: delete the private SSH key for User from config_files
  hosts: localhost
  tasks:
  - name: Delete private SSH key for User from config_files
    file:
      path: /home/{{ username }}/ansible/config_files/{{ username }}_id_rsa
      state: absent